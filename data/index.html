<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>摩根太平洋科技基金（968061）估值</title>
  <link href="https://hk-ob-test.oss-cn-hongkong.aliyuncs.com/qdii/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; }
    .custom-table { border: none !important; }
    .custom-table th, .custom-table td { border: none !important; padding: 0.1rem 0.1rem; }
    .custom-table thead th { background-color: white !important; font-weight: 600; }
    .table-wrapper { background: white; box-shadow: 0 8px 16px rgba(0,0,0,0.12); border-radius: 8px; overflow-x: auto; }
    .tables-flex { display: block; }
    @media (min-width: 992px) {
      .tables-flex {
        display: flex;
        gap: 0;
        justify-content: flex-start;
        align-items: flex-start;
      }
      #history-wrapper {
        margin-top: 0 !important;
      }
    }
    @media (min-width: 768px) {
      .custom-table th, .custom-table td { padding: 0.5rem 1rem !important; }
      .info-wrapper { padding: 0.1rem 1rem; }
    }
    .table-wrapper:not(:last-child) {
       margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
  <div class="alert alert-info text-center" role="alert" style="font-size:0.8rem;">
      开市期间数据实时更新。仅供参考，不构成任何投资建议。
  </div>
  <div class="tables-flex">
    <div class="table-wrapper shadow rounded p-3" id="realtime-wrapper">
      <p class="text-muted mb-1 info-wrapper" style="font-size: 0.7rem;">摩根太平洋科技（968061）估值</p>
      <p class="text-muted mb-1 info-wrapper" id="update-time" style="font-size: 0.7rem;">加载中...长时间未加载请刷新网页</p>
      <table class="table custom-table">
        <thead class="table-light">
          <tr>
            <th>名称</th>
            <th class="text-end">仓位</th>
            <th class="text-end">涨跌幅</th>
          </tr>
        </thead>
        <tbody id="equity-tbody">
          <tr><td colspan="3">加载中...</td></tr>
        </tbody>
        <tfoot>
          <tr class="fw-bold">
            <td>总仓位</td>
            <td class="text-end" id="total-weight"></td>
            <td class="text-end" id="total-percent"></td>
          </tr>
          <tr>
            <td>今日开市</td>
            <td class="text-end" id="today-weight"></td>
            <td class="text-end" id="today-percent"></td>
          </tr>
        </tfoot>
      </table>
      <p class="text-muted mb-1 text-end info-wrapper" style="font-size: 0.7rem;">持仓截至 2025-05-31</p>
    </div>
    <div class="table-wrapper shadow rounded p-3" id="history-wrapper">
      <p class="text-muted mb-1 info-wrapper" style="font-size: 0.7rem;">历史估值</p>
      <p class="text-muted mb-1 info-wrapper" id="history-stats" style="font-size: 0.7rem;">加载中...长时间未加载请刷新网页</p>
      <table class="table custom-table">
        <thead>
          <tr>
            <th>日期</th>
            <th class="text-end">估值</th>
            <th class="text-end">净值</th>
          </tr>
        </thead>
        <tbody id="history-tbody">
          <tr><td colspan="3">加载中...</td></tr>
        </tbody>
      </table>
      <p class="text-muted mb-1 text-end info-wrapper" style="font-size: 0.7rem;">净值由美元换算后会有些许出入</p>
    </div>
    </div>
    <div class="footer text-muted mt-5 text-center">
      <p><a href="https://github.com/UYWsWTscLh2VXqT7/update_968061" target="_blank">问题反馈及开源地址</a><br>powered by <a href="https://github.com/xiaopc/qdii-value" target="_blank">qdii-value</a></p>
    </div>  
    </div>
    <script>
      function colorize(val) {
        val = parseFloat(val);
        if (val > 0) return 'text-danger';
        if (val < 0) return 'text-success';
        return 'text-muted';
      }
      function cleanName(name) {
        // 反复去除无意义单词，直到全部去掉
        let pattern = /(\s|^)(ltd|co\s+ltd|co|holding|holdings|inc|corp|corporation|plc|group|company)(\s|\.|,|$)/gi;
        let cleaned = name;
        let old;
        do {
          old = cleaned;
          cleaned = cleaned.replace(pattern, ' ');
        } while (cleaned !== old);
        // 替换 technology 为 Tec.
        cleaned = cleaned.replace(/technology/gi, 'Tec.');
        cleaned = cleaned.replace(/\s+/g, ' ').trim();
        return cleaned;
      }

      // 判断是否为移动端
      const isMobile = window.innerWidth < 768;

      // 动态调整样式
      function applyResponsiveStyle() {
        if (isMobile) {
          document.body.style.fontSize = "0.8rem";
          document.body.style.padding = "2rem";
          document.querySelectorAll('.table-wrapper').forEach(el => {
            el.style.display = "";
            el.style.margin = "";
            el.style.maxWidth = "";
            el.style.width = "100%";
            el.style.padding = "0.2rem 0.5rem";
          });
          document.querySelectorAll('table').forEach(tb => {
            tb.style.width = "100%";
            tb.style.margin = "";
          });
        } else {
          document.body.style.fontSize = "1rem";
          document.body.style.padding = "2rem";
          document.querySelectorAll('.table-wrapper').forEach(el => {
            el.style.display = "table";
            el.style.margin = "auto";
            el.style.maxWidth = "900px";
            el.style.width = "auto";
            el.style.padding = "2rem";
          });
          document.querySelectorAll('table').forEach(tb => {
            tb.style.width = "auto";
            tb.style.margin = "0 auto";
          });
        }
      }
      applyResponsiveStyle();
      window.addEventListener('resize', applyResponsiveStyle);

      // 加载实时数据
      async function loadRealtime() {
        const url = "https://hk-ob-test.oss-cn-hongkong.aliyuncs.com/qdii/realtime.json";
        try {
          const resp = await fetch(url + '?_t=' + Date.now());
          const data = await resp.json();
          document.getElementById("update-time").innerText = "更新于 " + data.update_time;
          // 渲染表格
          const tbody = document.getElementById("equity-tbody");
          tbody.innerHTML = "";
          data.equities.forEach(eq => {
            tbody.innerHTML += `
              <tr>
                <td>${isMobile ? cleanName(eq.name) : eq.name}</td>
                <td class="text-end">${parseFloat(eq.weight).toFixed(2)}%</td>
                <td class="text-end ${colorize(eq.change_percent)}">${parseFloat(eq.change_percent).toFixed(2)}%</td>
              </tr>
            `;
          });
          // 汇总
          document.getElementById("total-weight").innerText = parseFloat(data.summary.total_weight).toFixed(2) + "%";
          document.getElementById("total-percent").innerHTML = `<span class="${colorize(data.summary.total_percent)}">${parseFloat(data.summary.total_percent).toFixed(2)}%</span>`;
          document.getElementById("today-weight").innerText = parseFloat(data.summary.today_weight).toFixed(2) + "%";
          document.getElementById("today-percent").innerHTML = `<span class="${colorize(data.summary.today_percent)}">${parseFloat(data.summary.today_percent).toFixed(2)}%</span>`;
        } catch (e) {
          document.getElementById("update-time").innerText = "数据加载失败，请联系站长";
          document.getElementById("equity-tbody").innerHTML = `<tr><td colspan="3">数据加载失败，请联系站长</td></tr>`;
        }
      }
    async function loadHistory() {
      const url = "https://hk-ob-test.oss-cn-hongkong.aliyuncs.com/qdii/history.json";
      try {
        const resp = await fetch(url + '?_t=' + Date.now());
        const data = await resp.json();
        // 误差与准确率统计
        let errors = [];
        let success = 0, fail = 0;
        data.forEach(entry => {
          let est = parseFloat(entry.total_percent);
          let nav = parseFloat(entry.nav_change_pct);
          if (!isNaN(est) && !isNaN(nav)) {
            if (nav !== 0) {
              errors.push(Math.abs(est - nav) / Math.abs(nav) * 100);
            }
            if (est !== 0 && nav !== 0) {
              if ((est > 0 && nav > 0) || (est < 0 && nav < 0)) success++;
              else fail++;
            }
          }
        });
        let meanError = errors.length ? (errors.reduce((a, b) => a + b, 0) / errors.length).toFixed(2) + "%" : "—";
        let accuracy = (success + fail) ? (success / (success + fail) * 100).toFixed(2) + "%" : "—";
        document.getElementById("history-stats").innerText = `平均误差 ${meanError}，涨跌正确率 ${accuracy}`;
        // 渲染历史表格
        const tbody = document.getElementById("history-tbody");
        tbody.innerHTML = "";
        data.slice(-30).forEach(record => {
          let date = record.date;
          let val = parseFloat(record.total_percent);
          let nav_raw = record.nav_change_pct;
          let nav_val = parseFloat(nav_raw);
          let nav_str, nav_color;
          if (!isNaN(nav_val)) {
            nav_str = nav_val.toFixed(2) + "%";
            nav_color = nav_val > 0 ? "text-danger" : nav_val < 0 ? "text-success" : "text-muted";
          } else {
            nav_str = nav_raw;
            nav_color = "";
          }
          let color = val > 0 ? "text-danger" : val < 0 ? "text-success" : "text-muted";
          tbody.innerHTML += `
            <tr>
              <td>${date}</td>
              <td class="text-end ${color}">${val.toFixed(2)}%</td>
              <td class="text-end ${nav_color}">${nav_str}</td>
            </tr>
          `;
        });
      } catch (e) {
        document.getElementById("history-stats").innerText = "数据加载失败，请联系站长";
        document.getElementById("history-tbody").innerHTML = `<tr><td colspan="3">数据加载失败，请联系站长</td></tr>`;
      }
    }
    loadRealtime();
    loadHistory();
    </script>
</body>
</html>
